var latitude = "-1"; // 纬度
var accuracy = "-1"; // 经纬度的精度（米）
var longitude = "-1"; // 经度
function showpassword() {
	if (localStorage.remreberCid == companyId) {
		language = localStorage.rememberLAN;
		$('#Name').val(localStorage.rememberName);
		$('#Email').val(localStorage.rememberEML);
		$('#' + language).addClass('btn-info');
		$("#nextButton").click();
	}
}

function remember(companyId, name, email, language) {
	localStorage.remreberCid = companyId;
	localStorage.rememberLAN = language;
	localStorage.rememberEML = email;
	localStorage.rememberName = name;
}

function clearLine() {
	$.ajax({
		url : root + "wx/schoolInfo/clearQueueInfo",
		type : "post",
		dataType : "json",
		contentType : "application/json",
		success : function(result) {
		}
	})
}
/**
 * 改变错误样式
 */
function validInput(id, verifyExp) {
	var valueTmp = $("#" + id + "").val();
	if (!valueTmp || valueTmp == "" || verifyExp.test(valueTmp)) {
		$("#" + id + "").css("border", "1px solid #ff3600");
		// $("#" + id + "").val("");
	} else {
		$("#" + id + "").css("border", "1px solid #00da29");
	}
}

function change(id) {
	$("#" + id + "").removeClass("ne");
}

$("#passButton").click(function() {
	$("#button_b").click();
	$("#FULL_NAME").attr("disabled", false);
	$("#EMAIL").attr("disabled", false);
	$("#nextButton").removeAttr("disabled");
});

function getBasicInput() {
	if (session_mail != "") {
		$("#Email").val(session_mail);
	}
	if (session_name != "") {
		$("#Name").val(session_name);
	}
}

function add(result) {
		 type = result.data.partDatas;
		 var length = result.data.partDatas.length;
		 console.log(length)
		 switch(length){
		 case 1:
			 $('#total-part').text("一");
			 break;
		 case 2:
			 $('#total-part').text("二");
			 break;
		 case 3:
			 $('#total-part').text("三");
			 break;
		 }
		 var sugTime = 0;var totalLength = 0;
		 for ( var i = 0; i < length; i++) {
			 $(".skillCountInfos").append(
					 '<li style="color:#00A8FF;list-style:inside">' + type[i].partDesc + ":"
					 + type[i].questionLength + "道(限时"+(type[i].suggestTime/60).toFixed(0)+"分钟)</li>");
			 var a  = (type[i].suggestTime/60).toFixed(0);
			 sugTime = a*1 + sugTime*1;
			 var b = type[i].questionLength*1;
			 totalLength = b+totalLength*1;
		 }
		 $("#questionLength").text(totalLength);
		 $("#suggestTime").text(sugTime);
}

var language = 1;

function getLanguage() {
	var success = false;
	$.ajax({
		url : root + "wx/schoolExam/generatePaper",
		type : "post",
		contentType : "application/json",
		dataType : "json",
		beforeSend : function() {
			$(".btn-lg").attr("disabled", "disabled").unbind("click");
		},
		success : function(result) {
			if (result.code == 0) {
				success = true;
				add(result);
				$("#partDesc").text(result.data.partDatas[0].partDesc);
				/*$("#suggestTime").text(
						(result.data.partDatas[0].suggestTime / 60).toFixed(0));*/
				/*$("#questionLength").text(
						result.data.partDatas[0].questionLength);*/
			} else {
				setTimeout(function() {
					$(".page_er").show().text("网络数据异常");
					setTimeout(function() {
						$(".page_er").hide();
					}, 5e3);
				}, 0);
			}
		},
		error : function() {
			setTimeout(function() {
				$(".page_er").show().text("网络数据异常");
				setTimeout(function() {
					$(".page_er").hide();
				}, 5e3);
			}, 0);
		},
		complete : function() {
		}
	});
}

	var position_option = {
		enableHighAccuracy : true,
		maximumAge : 0,
		timeout : 20000
	};

	function getPositionSuccess(position) {
		try{
			latitude = position.coords.latitude.substring(0,20);// 纬度
			longitude = position.coords.longitude.substring(0,20);// 经度
			accuracy = position.coords.accuracy.substring(0,20);// 经纬度的精度（米）
			console.log("纬度:"+latitude+"经度:"+longitude);
		}catch(e)
		{
		}
	}

	function getPositionError(error) {
		switch (error.code) {
			case error.TIMEOUT:
				//alert("连接超时，请重试");
				break;
			case error.PERMISSION_DENIED:
				//alert("您拒绝了使用位置共享服务");
				break;
			case error.POSITION_UNAVAILABLE:
				//alert("获取位置信息失败");
				break;
		}
	}


function commitBasicInfo() {
	
	var datas = [];
	var data = {};
	data.id = {
		infoId : "FULL_NAME"
	};
	data.value = $("#Name").val();
	data.realValue = data.value;
	datas.push(data);
	var data = {};
	data.id = {
		infoId : "EMAIL"
	};
	data.value = $("#Email").val().trim();
	data.realValue = data.value;
	datas.push(data);
	$.ajax({
		url : root + "wx/schoolInfo/commitBasicInfo/" + companyWeixinId+"/"+longitude+"/"+latitude+"/"+accuracy,
		type : "post",
		beforeSend : function(){
			$("#nextButton").attr("disabled",true);
		},
		contentType : "application/json",
		dataType : "json",
		timeout:"60000",
		data : JSON.stringify(datas),
		success : function(result) {
			if (result.code != 0) {
				setTimeout(function() {
					$("#error").show();
					setTimeout(function() {
						$("#error").hide();
					}, 5e3);
				}, 0);
				return;
			}
			
			if (result.data.pageState == 30) {
				$("#button_a").click();
				$("#pageone").hide();
				$("#pagetwo").show();
				$("#FULL_NAME").attr("disabled", true);
				$("#EMAIL").attr("disabled", true);
				getInput();
				getLanguage();
			} else if (result.data.pageState == 31) {
				if(modelFlag){
					location.replace(root
							+ "wx/weixinapp/startPaper?modelFlag=1#wechat_webview_type=1");
				}else{
					location.replace(root
							+ "wx/weixinapp/startPaper#wechat_webview_type=1");
				}
			} else if (result.data.pageState == 32) {
				if(modelFlag){
					location.replace(root
							+ "wx/weixinapp/handInPaper?modelFlag=1#wechat_webview_type=1");
				}else{
					location.replace(root
							+ "wx/weixinapp/handInPaper#wechat_webview_type=1");
				}
			}
		},error:function(){
			alert("您的网络出现问题了，请检查网络后重试");
			$('#nextButton').removeAttr("disabled");
		}
	});
}
var newData = "";
/**
 * 根据result显示输入框?
 */
function viewType(result) {// ?干什么用的方法.加上注释,不然可读性太差
	// console.log(result);
	var length = result.data.length;
	var view = result.data;// view为服务器传回的数据
	newData = view;// newData设置成传回数据
	for ( var i = 0; i < length; i++) {
		var type = view[i].valueType;// label/select/input/query
		var id = view[i].infoId;
		var value = view[i].value;
		var realValue = "";
		if(view[i].realVlaue){
			realValue = view[i].realValue;
		}
		var infoName = view[i].infoName;
		var range = view[i].range;// select中的option
		var data = [];
		var data2 = [];
		if (type == "label")// 只看
		{
			data
					.push('<input type="text" disabled="disabled" id='
							+ id
							+ ' class=" index_input username readyOnly new_index" value='
							+ value + ' />')
		}
		if (type == "input" || type == "address")// 输入
		{
			if(realValue!=""){
				data.push('<input type="text" id=' + id
						+ ' class="index_input tel new_index" value=' + realValue
						+ ' placeHolder ="请填写' + infoName + '"  />');
			}
			else if (value) {
				data.push('<input type="text" id=' + id
						+ ' class="index_input tel new_index" value=' + value
						+ ' placeHolder ="请填写' + infoName + '"  />');
			} else {
				data
						.push('<input type="text" id='
								+ id
								+ ' class="index_input tel new_index" placeHolder ="请填写'
								+ infoName + '"/>');
			}
		}
		if (type == "query") {// ?什么东东?
			if(realValue!=""){
				data
				.push('<input id='
						+ id
						+ ' type="text" class="index_input school new_index" value='
						+ realValue + ' placeHolder ="请填写' + infoName + '"  />');
			}
			else if(value)
				{
				data
				.push('<input id='
						+ id
						+ ' type="text" class="index_input school new_index" value='
						+ value + ' placeHolder ="请填写' + infoName + '"  />');
				}
			else{
				data
				.push('<input id='
						+ id
						+ ' type="text" class="index_input school new_index"  placeHolder ="请填写' + infoName + '"  />');
			}
		}
		if (type == "select")// 下拉框
		{
			var range_length = parseInt(range.length);
			select(range_length, data2, id, range, infoName);
		}
		var $newEle = $(data.join(''));
		$newEle.data('info', view[i]);

		$('#secondPart').append($newEle);
		$('#thirdPart').append(data2.join(''));// data2的下拉框
	}
	
	$('#secondPart').on('keyup', '.new_index', function() {
		var verifyExpStr = $(this).data('info').verifyExp;// 校验字符串
		var valueTmp = $(this).val();
		try {

			var verifyExp = new RegExp(verifyExpStr);
		} catch (e) {
			var verifyExp = /\S+/;
		}
		if (!valueTmp || valueTmp == "" || !verifyExp.test(valueTmp)) {
			$(this).css("border", "1px solid #ff3600");
			// $("#" + id + "").val("");
		} else {
			$(this).css("border", "1px solid #00da29");
		}

	});

	$('#thirdPart')
			.append(
					'<button type="button" id="nextButton1" class="btn-info btn-block" style="margin-top:20px">开始考试</button>');
}
/*
 * 生成一个select
 */
function select(length, data2, id, range, infoName) {
	data2.push('<select id=' + id
			+ ' class="select select_mod" onchange="change(this.id)">');
	data2.push('<option value="-1">请选择' + infoName + '</option>');
	for ( var i = 0; i < length; i++) {
		data2.push('<option value=' + range[i].key + '>' + range[i].value
				+ '</option>')
	}
	data2.push('</select>');
}

function getInput() {
	$.ajax({
		url : root + "wx/schoolInfo/getInput",
		type : "post",
		contentType : "application/json",
		dataType : "json",
		success : function(result) {
			if (result.code != 0) {
				setTimeout(function() {
					$("#error").show();
					setTimeout(function() {
						$("#error").hide();
					}, 5e3);
				}, 0);
				return;
			}
			viewType(result);
			var datas = result.data;
			for ( var i = 0; i < datas.length; i++) {
				var data = datas[i];
				if(data.valueType=="select"){
					var $ele = $("#" + data.infoId);
					$ele.val(data.value);
				}
				else if(data.value){
					var $ele = $("#" + data.infoId);
					$ele.val(data.realValue);
				}
				else{
					var $ele = $("#" + data.infoId);
				}
			}

		}
	});
}
/*
 * 提交数据
 */
function conmmitInfo(datas) {
	// console.log(datas);
	// return;
	$.ajax({
		url : root + "wx/schoolInfo/commitInfo",
		type : "post",
		contentType : "application/json",
		dataType : "json",
		timeout:"60000",
		data : JSON.stringify(datas),
		beforeSend : function() {
			$("#passButton").attr("disabled", "disabled");
			$("#nextButton1").attr("disabled", "disabled").text("试卷生成中...");
		},
		success : function(result) {
			if (result.code != 0) {
				setTimeout(function() {
					$("#nextButton1").text("提交失败");
					setTimeout(function() {
						$("#nextButton1").removeAttr("disabled").text("开始考试");
						$("#passButton").removeAttr("disabled");
					}, 2e3);
				}, 2e3);
				return;
			}
			if (result.code == 0) {
				if(modelFlag){
					location.replace(root
							+ "wx/weixinapp/startPaper?modelFlag=1#wechat_webview_type=1");
				}else{
					location.replace(root
							+ "wx/weixinapp/startPaper#wechat_webview_type=1");
				}
			}
		},
		error:function(){
			alert("您的网络出现问题了，请检查网络后重试");
			$("#nextButton1").removeAttr("disabled").text("开始考试");
			$("#passButton").removeAttr("disabled");
		}
	});
}

function bindEvent() {

	$(".btn-group").find("a").click(function() {
		$("a").removeClass("btn-info");
		$(this).addClass("btn-info");
		language = $(this).text();
		language = language.toLocaleLowerCase();
	});
	$(".btn-lg").click(function() {
		$(".btn-lg").removeClass("wrn");
	});

	$("#nextButton").click(
			function() {
				$(".page_er").hide();
				$('.skillCountInfos').empty();
				Name = $("#Name").val().trim();
				Email = $("#Email").val().trim();
				if (!Name) {
					$("#Name").val("");
					$("#Name").css("border", "1px solid #ff3600");
				}
				if (Name != "") {
						$("#Name").css("border", "1px solid #00da29");
				}
				if (!Email) {
					$("#Email").val("");
					$("#Email").css("border", "1px solid #ff3600");
				}
				if (!zz_email.test(Email)) {
					setTimeout(function() {
						$(".page_er").show().text("邮箱格式不正确，请切换英文输入法输入");
						setTimeout(function() {
							$(".page_er").hide();
						}, 5e3);
					}, 0);
					$("#Email").css("border", "1px solid #ff3600");
				}
				if (Email != "") {
					if (zz_email.test(Email)) {
						$("#Email").css("border", "1px solid #00da29");
					}
				}
				if (Name != "" && Email != ""
						&& zz_email.test(Email)) {
						$("#FULL_NAME").val(Name);
						$("#EMAIL").val(Email);
						remember(companyId, Name, Email, language);
						commitBasicInfo();
					
				}
			});
	/**
	 * 点击开始考试,回传数据
	 */
	$("#thirdPart")
			.on(
					'click',
					'#nextButton1',
					function() {
						var datas = [];
						var length = newData.length;
						var validFlag = true;
						for ( var i = 0; i < length; i++) {
							var data = {};// 回传数据的每一项
							var infoId = newData[i].infoId;// ID
							data.id = {
								infoId : newData[i].infoId
							};
							// console.log($("#" + infoId + ""));
							data.value = $("#" + infoId + "").val();// 获取value,这个正确
							if (newData[i].valueType == "select")// 如果是select就要选出来,获取realValue
							{
								if ($('#' + infoId).val() == -1) {// 如果是-1就不要将data存入
									$('#' + infoId).addClass("ne");
									validFlag = false;
									continue;
								}

								var selectInput = document
										.getElementById(infoId);// 获得js对象,利用js对象来获取他的option.jquery应该也可以,不过我不会,哈哈
								data.realValue = selectInput.options[selectInput.selectedIndex].text;
								// alert(data.realValue);

							} else {// 不是select的

								if (data.value == "") {
									validFlag = false;
									$('#' + infoId).css("border",
											"1px solid #ff3600");
									continue;
								}
								if (infoId == 'PHONE'
										&& !zz_phone.test(data.value)
										|| infoId == 'GRADUATE_COLLEGE'
										&& !zz_college.test(data.value)
										|| infoId == 'EXPECTED_SALARY'
										&& isNaN(data.value)) {// 格式验证
									validFlag = false;
									$('#' + infoId).css("border",
											"1px solid #ff3600");
									continue;
								}
								data.realValue = data.value;
							}
							datas.push(data);

						}
						if (validFlag) {
							conmmitInfo(datas);
						}
					});
	$("#welcome").click(function() {
		$("#wel_next").click();
	});
	$("#passButton").click(function() {
		$(".skillCountInfos").empty();
		$('#secondPart').empty();
		$('#thirdPart').empty();
		$("#pageone").show();
		$("#pagetwo").hide();
	});
}

$(document).ready(function() {
	var activity_name = JSON.parse(act_id).positionName;
	if(weixinCompany==1&&notify==1&&!modelFlag){
		$('.code_end').show();
	}
	document.title=activity_name;
	if (navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(getPositionSuccess,getPositionError, position_option);
    }
	$("#hello").hide();
	$("#pageone").show();
	$("#weiKao").hide();
	$("#yiKao").hide();
	$(".page_er").hide();
	clearLine()
	bindEvent();
	showpassword();
	getBasicInput();

});